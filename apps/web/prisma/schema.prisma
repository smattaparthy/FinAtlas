generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============== AUTH ==============
// UserRole values: "ADMIN", "USER"

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  passwordHash    String
  name            String?
  role            String   @default("USER")
  anthropicApiKey String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  households Household[]
}

// ============== HOUSEHOLD ==============

model Household {
  id          String   @id @default(cuid())
  name        String
  ownerUserId String
  anchorDate  DateTime @default(now())
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner     User               @relation(fields: [ownerUserId], references: [id], onDelete: Cascade)
  members   HouseholdMember[]
  scenarios Scenario[]

  @@index([ownerUserId])
}

model HouseholdMember {
  id            String   @id @default(cuid())
  householdId   String
  name          String
  birthDate     DateTime?
  retirementAge Int?
  roleTag       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  household Household  @relation(fields: [householdId], references: [id], onDelete: Cascade)
  incomes   Income[]
  accounts  Account[]
  loans     Loan[]

  @@index([householdId])
}

// ============== SCENARIO ==============

model Scenario {
  id          String   @id @default(cuid())
  householdId String
  name        String
  description String?
  isBaseline  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  household   Household          @relation(fields: [householdId], references: [id], onDelete: Cascade)
  assumptions ScenarioAssumption?
  taxProfile  TaxProfile?
  incomes     Income[]
  expenses    Expense[]
  accounts    Account[]
  loans       Loan[]
  goals       Goal[]
  lifeEvents  LifeEvent[]
  shareTokens ShareToken[]
  importLogs  ImportLog[]
  cache       EngineResultCache?

  @@index([householdId])
}

model ScenarioAssumption {
  id                      String   @id @default(cuid())
  scenarioId              String   @unique
  projectionYears         Int      @default(30)
  inflationRate           Float    @default(0.025)
  defaultGrowthRate       Float    @default(0.07)
  retirementWithdrawalRate Float   @default(0.04)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  scenario Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
}

// ============== TAX ==============
// FilingStatus values: "SINGLE", "MFJ", "HOH"
// TaxJurisdiction values: "FEDERAL", "STATE"

model TaxProfile {
  id                       String   @id @default(cuid())
  scenarioId               String   @unique
  filingStatus             String   @default("SINGLE")
  state                    String?
  taxYear                  Int      @default(2024)
  includePayrollTaxes      Boolean  @default(true)
  advancedOverridesEnabled Boolean  @default(false)
  payrollOverrides         String?  // JSON string
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  scenario Scenario   @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  taxRules TaxRule[]
}

model TaxRule {
  id           String   @id @default(cuid())
  taxProfileId String
  jurisdiction String   // "FEDERAL" or "STATE"
  bracketStart Float
  bracketEnd   Float?
  rate         Float
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  taxProfile TaxProfile @relation(fields: [taxProfileId], references: [id], onDelete: Cascade)

  @@index([taxProfileId])
}

// ============== INCOME ==============
// Frequency values: "MONTHLY", "BIWEEKLY", "WEEKLY", "ANNUAL", "ONE_TIME"
// GrowthRule values: "NONE", "FIXED", "INFLATION", "INFLATION_PLUS"

model Income {
  id          String    @id @default(cuid())
  scenarioId  String
  memberId    String?
  name        String
  amount      Float
  frequency   String    @default("ANNUAL")
  startDate   DateTime
  endDate     DateTime?
  growthRule  String    @default("NONE")
  growthRate  Float?
  isTaxable   Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  scenario Scenario         @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  member   HouseholdMember? @relation(fields: [memberId], references: [id], onDelete: SetNull)

  @@index([scenarioId])
}

// ============== EXPENSE ==============

model Expense {
  id              String    @id @default(cuid())
  scenarioId      String
  name            String
  amount          Float
  frequency       String    @default("MONTHLY")
  startDate       DateTime
  endDate         DateTime?
  growthRule      String    @default("INFLATION")
  growthRate      Float?
  category        String?
  isDiscretionary Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  scenario Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@index([scenarioId])
}

// ============== INVESTMENT ==============
// AccountType values: "TRADITIONAL_401K", "ROTH_401K", "TRADITIONAL_IRA", "ROTH_IRA", "BROKERAGE", "SAVINGS", "HSA", "529"

model Account {
  id          String    @id @default(cuid())
  scenarioId  String
  memberId    String?
  name        String
  type        String    @default("BROKERAGE")
  balance     Float     @default(0)
  growthRule  String    @default("FIXED")
  growthRate  Float?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  scenario      Scenario          @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  member        HouseholdMember?  @relation(fields: [memberId], references: [id], onDelete: SetNull)
  holdings      Holding[]
  contributions Contribution[]

  @@index([scenarioId])
}

model Holding {
  id        String    @id @default(cuid())
  accountId String
  symbol    String
  name      String?
  shares    Float
  costBasis Float?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
}

model Contribution {
  id                 String    @id @default(cuid())
  accountId          String
  amount             Float
  frequency          String    @default("ANNUAL")
  startDate          DateTime
  endDate            DateTime?
  employerMatch      Float?
  employerMatchLimit Float?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
}

// ============== LOAN ==============
// LoanType values: "MORTGAGE", "AUTO", "STUDENT", "PERSONAL", "HELOC", "OTHER"

model Loan {
  id             String    @id @default(cuid())
  scenarioId     String
  memberId       String?
  name           String
  type           String    @default("OTHER")
  principal      Float
  currentBalance Float
  interestRate   Float
  monthlyPayment Float
  startDate      DateTime
  termMonths     Int
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Mortgage-specific fields (nullable for other loan types)
  propertyAddress       String?
  propertyZipCode       String?
  propertyCity          String?
  propertyState         String?
  propertyCounty        String?
  propertyValue         Float?
  annualPropertyTax     Float?
  annualHomeInsurance   Float?
  monthlyHOAFees        Float?
  monthlyPMI            Float?
  pmiRequired           Boolean   @default(false)
  insuranceProvider     String?
  hoaName               String?

  scenario Scenario         @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  member   HouseholdMember? @relation(fields: [memberId], references: [id], onDelete: SetNull)

  @@index([scenarioId])
}

// ============== GOAL ==============
// GoalType values: "RETIREMENT", "EDUCATION", "MAJOR_PURCHASE", "EMERGENCY_FUND", "CUSTOM"

model Goal {
  id           String    @id @default(cuid())
  scenarioId   String
  name         String
  type         String    @default("CUSTOM")
  targetAmount Float
  targetDate   DateTime?
  priority     Int       @default(1)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  scenario Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@index([scenarioId])
}

// ============== LIFE EVENT ==============
// LifeEventType values: "BUY_HOUSE", "HAVE_BABY", "RETIRE_EARLY", "CAREER_CHANGE", "CUSTOM"

model LifeEvent {
  id          String   @id @default(cuid())
  scenarioId  String
  name        String
  type        String   @default("CUSTOM")
  targetDate  DateTime
  description String?
  color       String   @default("#10b981")
  icon        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  scenario Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@index([scenarioId])
}

// ============== SHARE TOKEN ==============

model ShareToken {
  id          String    @id @default(cuid())
  scenarioId  String
  token       String    @unique
  expiresAt   DateTime?
  createdBy   String
  accessCount Int       @default(0)
  createdAt   DateTime  @default(now())

  scenario Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([scenarioId])
}

// ============== IMPORT ==============

model ImportLog {
  id           String   @id @default(cuid())
  scenarioId   String
  fileName     String
  rowsImported Int
  status       String
  errorDetails String?  // JSON string
  createdAt    DateTime @default(now())

  scenario Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@index([scenarioId])
}

// ============== ENGINE CACHE ==============

model EngineResultCache {
  id            String   @id @default(cuid())
  scenarioId    String   @unique
  engineVersion String
  inputHash     String
  resultsJson   String   // JSON string
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  scenario Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
}
